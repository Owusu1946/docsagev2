<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocSage V2 | Advanced API Tester</title>

    <!-- Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <!-- Marked & DomPurify -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --surface-hover: #27272a;
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --text: #e4e4e7;
            --text-muted: #a1a1aa;
            --border: #27272a;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            padding: 2rem;
            gap: 2rem;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            height: calc(100vh - 4rem);
        }

        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            z-index: 20;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #fff;
        }

        .brand i {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        input[type="text"],
        select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: 0.2s border;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-hover);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .btn-generate {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-generate:hover {
            background: var(--primary-dark);
        }

        .btn-generate:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            z-index: 20;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--surface-hover);
            color: #fff;
            border-color: var(--border);
        }

        .tool-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .tool-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .output-container {
            flex-grow: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        /* Views */
        .view-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            background: var(--surface);
            width: 100%;
            height: 100%;
        }

        .view-layer.active {
            opacity: 1;
            visibility: visible;
            z-index: 5;
        }

        .code-view {
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            color: #d4d4d8;
            font-size: 0.9rem;
        }

        /* Preview View Styling */
        .preview-view {
            color: #d4d4d8;
            line-height: 1.6;
        }

        .preview-view h1,
        .preview-view h2 {
            color: #fff;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .preview-view h1:first-child {
            margin-top: 0;
        }

        .preview-view a {
            color: var(--primary);
        }

        .preview-view code {
            background: #27272a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono';
            font-size: 0.85em;
        }

        /* Highlight.js Override */
        .preview-view pre {
            background: #1e1e1e !important;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .preview-view pre code {
            background: transparent !important;
            padding: 0;
            font-family: 'JetBrains Mono';
        }

        .preview-view table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .preview-view th,
        .preview-view td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        .preview-view th {
            background: var(--surface-hover);
        }

        /* Loader & Visualizer */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        canvas#neural-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.6;
        }

        .loader-content {
            position: relative;
            z-index: 55;
            text-align: center;
            background: rgba(9, 9, 11, 0.7);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .phase-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .phase-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--primary);
            min-height: 1.4em;
        }

        .file-scroller {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 1rem;
            height: 100px;
            overflow: hidden;
            text-align: left;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
            opacity: 0.7;
            position: relative;
        }

        .file-scroller::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(9, 9, 11, 0.9));
        }

        .file-entry {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--surface-hover);
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast i {
            color: var(--success);
            font-size: 1.2rem;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                height: auto;
            }

            .output-container {
                min-height: 600px;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Config Panel -->
        <div class="sidebar">
            <div class="brand">
                <i class='bx bxs-bot'></i> DocSage <span
                    style="font-size:0.8rem; background: var(--surface-hover); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); color: var(--text-muted);">PRO</span>
            </div>

            <div class="form-group">
                <label>GitHub Repository</label>
                <input type="text" id="repoUrl" placeholder="https://github.com/..."
                    value="https://github.com/nestjs/typescript-starter">
            </div>

            <div class="form-group">
                <label>Author Alias</label>
                <input type="text" id="author" placeholder="Default: Repo Owner">
            </div>

            <div class="form-group">
                <label>Documentation Style</label>
                <select id="style">
                    <option value="Professional">Professional (Standard)</option>
                    <option value="Casual">Casual & Friendly</option>
                    <option value="Technical">Technical Deep Dive</option>
                    <option value="Minimalist">Minimalist</option>
                </select>
            </div>

            <div class="toggle-group">
                <label style="margin:0">Include Badges</label>
                <label class="switch">
                    <input type="checkbox" id="includeBadges" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <button class="btn-generate" onclick="generateDocs()" id="generateBtn">
                <i class='bx bxs-magic-wand'></i> Analyz & Generate
            </button>

            <div style="flex-grow: 1"></div>

            <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                <label><i class='bx bx-history'></i> Recent Scans</label>
                <div id="history-list" style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                    <!-- History -->
                </div>
            </div>
        </div>

        <!-- Output Area -->
        <div class="main-content">
            <div class="actions-bar">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('preview')"><i class='bx bx-show'></i>
                        Preview</button>
                    <button class="tab-btn" onclick="switchTab('code')"><i class='bx bx-code-alt'></i> Markdown</button>
                </div>
                <div style="display:flex; gap: 0.5rem;">
                    <button class="tool-btn" onclick="copyDocs()" title="Copy Markdown"><i
                            class='bx bx-copy'></i></button>
                    <button class="tool-btn" onclick="downloadDocs()" title="Download File"><i
                            class='bx bx-download'></i></button>
                </div>
            </div>

            <div class="output-container">
                <!-- Advanced Loader -->
                <div class="loader-overlay" id="loader">
                    <canvas id="neural-canvas"></canvas>
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <div class="phase-title" id="phase-title">Initializing System</div>
                        <div class="phase-log" id="phase-log">Establishing connection...</div>
                        <div class="file-scroller" id="file-scroller">
                            <!-- Simulated file logs -->
                        </div>
                    </div>
                </div>

                <div id="preview-view" class="view-layer preview-view active">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center;">
                        <i class='bx bxs-terminal' style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.2"></i>
                        <h3>Ready to Generate</h3>
                        <p style="max-width: 300px; margin-top: 0.5rem;">Enter a repository URL to start the deep
                            analysis engine.</p>
                    </div>
                </div>
                <div id="code-view" class="view-layer code-view"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class='bx bxs-check-circle'></i>
        <span>Copied to clipboard!</span>
    </div>

    <script>
        let currentMarkdown = '';
        let simulationInterval;
        let canvasAnimationId;

        // --- Neural Visualization Logic ---
        const canvas = document.getElementById('neural-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let nodes = [];

        function resizeCanvas() {
            if (!canvas.parentElement) return;
            width = canvas.width = canvas.parentElement.offsetWidth;
            height = canvas.height = canvas.parentElement.offsetHeight;
        }

        class Node {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
                this.radius = Math.random() * 2 + 1;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#8b5cf6';
                ctx.fill();
            }
        }

        function initVisualizer() {
            resizeCanvas();
            nodes = [];
            for (let i = 0; i < 40; i++) nodes.push(new Node());
            animateNetwork();
        }

        function animateNetwork() {
            ctx.clearRect(0, 0, width, height);

            // Update & Draw Nodes
            nodes.forEach(node => {
                node.update();
                node.draw();
            });

            // Draw Connections
            ctx.strokeStyle = 'rgba(139, 92, 246, 0.15)';
            ctx.lineWidth = 1;
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const dx = nodes[i].x - nodes[j].x;
                    const dy = nodes[i].y - nodes[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 100) {
                        ctx.beginPath();
                        ctx.moveTo(nodes[i].x, nodes[i].y);
                        ctx.lineTo(nodes[j].x, nodes[j].y);
                        ctx.stroke();
                    }
                }
            }
            canvasAnimationId = requestAnimationFrame(animateNetwork);
        }

        // --- Core Logic ---
        loadHistory();

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (tab === 'preview') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
            }

            document.querySelectorAll('.view-layer').forEach(v => v.classList.remove('active'));
            document.getElementById(tab + '-view').classList.add('active');
        }

        async function generateDocs() {
            const repoUrl = document.getElementById('repoUrl').value;
            const author = document.getElementById('author').value;
            const style = document.getElementById('style').value;
            const includeBadges = document.getElementById('includeBadges').checked;

            if (!repoUrl) return showToast('Please enter a URL', true);

            startSimulation();
            addToHistory(repoUrl);

            try {
                const API_URL = 'https://docsagev2.onrender.com/api/generate-docs';

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repoUrl, author, style, includeBadges })
                });

                const data = await response.json();

                if (!data.success) {
                    if (data.stack) console.error(data.stack);
                    throw new Error(data.error || 'Failed');
                }

                currentMarkdown = data.markdown;
                renderOutput();
                switchTab('preview');

            } catch (err) {
                alert('Error: ' + err.message); // Keep alert for errors, or use advanced toast? Simple is fine for error
                console.error(err);
            } finally {
                stopSimulation();
            }
        }

        function renderOutput() {
            document.getElementById('code-view').textContent = currentMarkdown;
            const cleanHtml = DOMPurify.sanitize(marked.parse(currentMarkdown));
            document.getElementById('preview-view').innerHTML = cleanHtml;

            // Syntax Highlight
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // --- High-Fidelity Simulator ---
        function startSimulation() {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('generateBtn').disabled = true;

            initVisualizer();

            const fileScroller = document.getElementById('file-scroller');
            const phaseTitle = document.getElementById('phase-title');
            const phaseLog = document.getElementById('phase-log');
            fileScroller.innerHTML = '';

            const realisticFiles = [
                'src/index.ts', 'package.json', 'README.md', 'src/controllers/auth.ts',
                'src/services/db.service.ts', '.gitignore', 'docker-compose.yml', 'tsconfig.json',
                'src/utils/logger.ts', 'src/middleware/cors.ts', 'public/index.html',
                'src/types/express.d.ts', 'tests/unit/app.spec.ts', '.env.example'
            ];

            let phase = 'clone';
            let ticks = 0;

            simulationInterval = setInterval(() => {
                ticks++;

                // Phase Management
                // Speed up phase management for better UX in "mock" mode, 
                // but in real API it waits for response. 
                // Let's just loop status messages until complete

                if (ticks < 15) {
                    phaseTitle.textContent = "Cloning Repository";
                    phaseLog.textContent = `git clone --depth 1 ...`;
                } else if (ticks < 40) {
                    phaseTitle.textContent = "Analyzing Codebase";
                    phaseLog.textContent = `Building Dependency Graph...`;

                    if (Math.random() > 0.3) {
                        const file = realisticFiles[Math.floor(Math.random() * realisticFiles.length)];
                        const div = document.createElement('div');
                        div.className = 'file-entry';
                        div.innerHTML = `<span style="color:#52525b">SCAN</span> ${file} <span style="color:#71717a; float:right">${Math.floor(Math.random() * 500)}B</span>`;
                        fileScroller.prepend(div);
                        if (fileScroller.children.length > 5) fileScroller.lastElementChild.remove();
                    }
                    if (nodes.length < 80 && ticks % 2 === 0) nodes.push(new Node());

                } else {
                    phaseTitle.textContent = "Generating Documentation";
                    phaseLog.textContent = "Consulting Gemini 2.5 Flash Model...";
                }
            }, 200);
        }

        function stopSimulation() {
            clearInterval(simulationInterval);
            cancelAnimationFrame(canvasAnimationId);
            document.getElementById('loader').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
        }

        function copyDocs() {
            if (!currentMarkdown) return;
            navigator.clipboard.writeText(currentMarkdown);
            showToast('Copied Markdown to clipboard!');
        }

        function downloadDocs() {
            if (!currentMarkdown) return;
            const blob = new Blob([currentMarkdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'README.md';
            a.click();
            showToast('Download started');
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            const span = toast.querySelector('span');

            icon.className = isError ? 'bx bxs-error-circle' : 'bx bxs-check-circle';
            icon.style.color = isError ? '#ef4444' : '#10b981';
            span.textContent = msg;

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // History
        function addToHistory(url) {
            let history = JSON.parse(localStorage.getItem('docsage_history') || '[]');
            if (!history.includes(url)) {
                history.unshift(url);
                if (history.length > 5) history.pop();
                localStorage.setItem('docsage_history', JSON.stringify(history));
                loadHistory();
            }
        }

        function loadHistory() {
            const container = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('docsage_history') || '[]');
            container.innerHTML = history.map(url => `
            <div style="font-size: 0.85rem; color: var(--primary); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 4px 8px; border-radius: 4px; transition: 0.2s;" 
                 onmouseover="this.style.background='var(--surface-hover)'"
                 onmouseout="this.style.background='transparent'"
                 onclick="document.getElementById('repoUrl').value='${url}'">
                <i class='bx bx-git-branch'></i> ${url.split('/').slice(-2).join('/')}
            </div>
        `).join('');
        }

        window.addEventListener('resize', resizeCanvas);
    </script>

</body>

</html>